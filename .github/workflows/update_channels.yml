name: Atualizar Estatísticas dos Canais

on:
  schedule:
    # Executa diariamente às 23:30 BRT (02:30 UTC do dia seguinte)
    # BRT = UTC-3, então 23:30 BRT = 02:30 UTC (próximo dia)
    # Horário antecipado para garantir execução no fim do dia sem atrasos
    - cron: '30 2 * * *'   # 23:30 BRT (02:30 UTC do dia seguinte)
  
  # Permite execução manual com seleção de canal
  workflow_dispatch:
    inputs:
      channel_id:
        description: 'ID do canal para atualizar (deixe vazio para atualizar todos)'
        required: false
        type: string

jobs:
  update_channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Atualizar estatísticas dos canais
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        YOUTUBE_API_KEYS: ${{ secrets.YOUTUBE_API_KEYS }}
        CHANNEL_ID: ${{ inputs.channel_id }}
      run: |
        python update_channels.py
    
    - name: Upload logs (se houver erro)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: channel-update-logs
        path: |
          *.log
          extrator.log

